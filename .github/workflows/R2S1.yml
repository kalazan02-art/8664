name: R2S Minimal OpenWrt Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Free disk space early
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /opt/hostedtoolcache
          df -h

      # Step 3: Install build dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev \
            python3 python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget
          sudo apt-get clean

      # Step 4: Install Python elftools globally
      - name: Install Python elftools
        run: |
          sudo pip3 install pyelftools
          python3 -c "import elftools; print('elftools ok')"

      # Step 5: Clone OpenWrt to /mnt
      - name: Clone OpenWrt to /mnt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown $USER:$USER /mnt/openwrt
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH /mnt/openwrt
          ln -s /mnt/openwrt $GITHUB_WORKSPACE/openwrt

      # Step 6: Update feeds
      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update luci packages
          ./scripts/feeds install -a -p luci
          ./scripts/feeds install -a -p packages

      # Step 7: Generate NanoPi R2S minimal config
      - name: Generate R2S minimal config
        run: |
          cd openwrt
          cat > .config << 'EOF'
CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv8=y
CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r2s=y

CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-ssl=y

CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_ipv6helper=y

CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

CONFIG_TARGET_ROOTFS_PARTSIZE=256
EOF
          make defconfig

      # Step 8: Download packages
      - name: Download packages
        run: |
          cd openwrt
          make download -j2
          find dl -size -1024c -delete

      # Step 9: Compile firmware
      - name: Compile firmware
        run: |
          cd openwrt
          make -j2 || make -j1 V=s

      # Step 10: Prepare firmware
      - name: Prepare firmware
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      # Step 11: Upload firmware to GitHub Release
      - name: Upload firmware to release
        uses: softprops/action-gh-release@v0.1.14
        with:
          tag_name: r2s-${{ github.run_number }}
          name: NanoPi R2S OpenWrt
          body: Minimal OpenWrt firmware for NanoPi R2S
          files: ${{ env.FIRMWARE }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
