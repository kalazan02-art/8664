name: R2S Minimal OpenWrt Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    # 增加权限设置，确保可以创建 Release
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune -a -f
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget
          sudo apt-get clean

      - name: Install Python elftools
        run: |
          # 修正：在新版 Ubuntu 中需使用 break-system-packages 或 venv
          pip3 install --user pyelftools

      - name: Clone OpenWrt
        run: |
          # 直接在当前工作目录克隆，避免复杂的软链接权限问题
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate R2S minimal config
        run: |
          cd openwrt
          cat > .config <<EOF
          CONFIG_TARGET_rockchip=y
          CONFIG_TARGET_rockchip_armv8=y
          CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r2s=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-ssl=y
          CONFIG_PACKAGE_ppp=y
          CONFIG_PACKAGE_ppp-mod-pppoe=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ipv6helper=y
          CONFIG_PACKAGE_kmod-usb-net=y
          CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
          CONFIG_TARGET_ROOTFS_PARTSIZE=256
          EOF
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -delete

      - name: Compile firmware
        run: |
          cd openwrt
          # 使用 nproc 自动获取 CPU 核心数提高速度
          make -j$(nproc) || make -j1 V=s

      - name: Prepare firmware
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          # 记录当前目录绝对路径到环境变量
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: r2s-${{ github.run_number }}
          name: NanoPi R2S OpenWrt (Build ${{ github.run_number }})
          body: |
            Minimal OpenWrt firmware for NanoPi R2S
            Source: ${{ env.REPO_URL }}
            Branch: ${{ env.REPO_BRANCH }}
          files: ${{ env.FIRMWARE_PATH }}/*
