name: R2S Minimal OpenWrt Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ① 最早释放磁盘（非常关键）
    - name: Free disk space (early)
      run: |
        sudo rm -rf /usr/share/dotnet \
                    /usr/local/lib/android \
                    /opt/ghc \
                    /opt/hostedtoolcache
        df -h

    # ② 基础编译环境（不装多余的）
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget
        sudo apt-get clean

    # ③ 使用 /mnt 作为 OpenWrt 工作目录
    - name: Clone OpenWrt to /mnt
      run: |
        sudo mkdir -p /mnt/openwrt
        sudo chown $USER:$USER /mnt/openwrt
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH /mnt/openwrt
        ln -s /mnt/openwrt $GITHUB_WORKSPACE/openwrt

    # ④ feeds（只更新必要的）
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update luci packages
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p packages

    # ⑤ 生成 R2S 最小 .config
    - name: Generate R2S minimal config
      run: |
        cd openwrt
        cat > .config << 'EOF'
        CONFIG_TARGET_rockchip=y
        CONFIG_TARGET_rockchip_armv8=y
        CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r2s=y

        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-base=y
        CONFIG_PACKAGE_luci-ssl=y

        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_ipv6helper=y

        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

        CONFIG_TARGET_ROOTFS_PARTSIZE=256
        EOF

        make defconfig

    # ⑥ 下载源码（限制并发）
    - name: Download packages
      run: |
        cd openwrt
        make download -j2
        find dl -size -1024c -delete

    # ⑦ 编译（不 clean）
    - name: Compile firmware
      run: |
        cd openwrt
        make -j2 || make -j1 V=s

    # ⑧ 只保留固件
    - name: Prepare firmware
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    # ⑨ 发布
    - name: Upload firmware to release
      uses: softprops/action-gh-release@v0.1.14
      with:
        tag_name: r2s-${{ github.run_number }}
        name: NanoPi R2S OpenWrt
        body: Minimal OpenWrt for NanoPi R2S
        files: ${{ env.FIRMWARE }}/*
        token: ${{ secrets.GITHUB_TOKEN }}
