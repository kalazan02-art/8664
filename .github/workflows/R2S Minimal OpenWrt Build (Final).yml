name: R2S Minimal OpenWrt Build (Final)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ① 最早释放磁盘（非常关键）
    - name: Free disk space (early)
      run: |
        sudo rm -rf /usr/share/dotnet \
                    /usr/local/lib/android \
                    /opt/ghc \
                    /opt/hostedtoolcache
        df -h

    # ② 安装最小必需编译依赖（Ubuntu 24.04 兼容）
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev \
          python3 python3-pip python3-setuptools \
          rsync unzip zlib1g-dev file wget
        sudo apt-get clean

    # ②b 安装 Python elftools（修复 u-boot binman 错误）
    - name: Install Python elftools
      run: |
        python3 -m pip install --user pyelftools
        export PATH=$HOME/.local/bin:$PATH
        python3 -c "import elftools; print('elftools ok')"

    # ③ 使用 /mnt 作为 OpenWrt 工作目录
    - name: Clone OpenWrt to /mnt
      run: |
        sudo mkdir -p /mnt/openwrt
        sudo chown $USER:$USER /mnt/openwrt
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH /mnt/openwrt
        ln -s /mnt/openwrt $GITHUB_WORKSPACE/openwrt

    # ④ feeds（只更新必要的）
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update luci packages
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p packages

    # ⑤ 生成 NanoPi R2S 最小配置
    - name: Generate R2S minimal config
      run: |
        cd openwrt
        cat > .config << 'EOF'
CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv8=y
CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r2s=y

CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-ssl=y

CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_ipv6helper=y

CON
